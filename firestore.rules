rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    
    
    function isSignedIn() {
      return request.auth != null;
    }

    function role() {
      return request.auth.token.role;
    }

    function isFacilityEngineer() {
      return isSignedIn() && role() == 'facility_engineer';
    }

    function isDirector() {
      return isSignedIn() && role() == 'sustainability_director';
    }

    function isAuditor() {
      return isSignedIn() && role() == 'auditor';
    }

    match /proposals/{runID} {
      allow read: if isDirector() || isAuditor()
          || (isFacilityEngineer() && resource.data.facility_id == request.auth.uid);
      allow update: if isDirector()
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['status','reviewer_uid', 'feedback_text', 
                    'reviewed_at', 'revision_count']);
        && request.resource.data.status in 
            ['pending_review', 'revision_requested', 'approved', 'rejected'];
    }

    match /agent_decisions/{decisionId} {
      allow read: if isDirector() || isAuditor();
      allow write: if false;
    }

    match /checkpoints/{checkpointId} {
      allow read, write: if false;
    }


  }
}
